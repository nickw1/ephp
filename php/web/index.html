<!DOCTYPE html>
<html>
<head>
<title>websocket</title>
<script type='text/javascript'>

var ws;

function init() {

    document.getElementById('start').onclick = function() {
        var xhr2 = new XMLHttpRequest();
        xhr2.addEventListener('load', function(e) {
            alert('launched processes: ' + e.target.responseText);
        });

            xhr2.open('POST', '/ephpii/launcher.php');
        var fd = new FormData();
        fd.append('cmd', 'start');
        xhr2.send(fd);
    };

    document.getElementById("connect").onclick = function() {
        ws=new WebSocket('ws://ephp.solent.ac.uk:8080');

        ws.onopen = function(e) {
            alert('opened');
            ws.send(JSON.stringify({"cmd":"open"}));
        }    

        ws.onmessage =function(e) {
            console.log("message="+e.data);
            document.getElementById("response").innerHTML += e.data + "<br />";
            var data = JSON.parse(e.data);
            if(data.started && data.started == 1) {
                alert('received start command');
                var xhr2_2 = new XMLHttpRequest();
                xhr2_2.addEventListener('load', function(e) {
                    alert('launched: ' + e.target.responseText);
                });
                xhr2_2.open('GET', '/ephpii/' + 
                document.getElementById('script').value + 
                    '?XDEBUG_SESSION_START=' +
                    document.getElementById('user').value
                    +'&u='+
                    document.getElementById('user').value);
                xhr2_2.send();
            }
        };

        ws.onerror = function(e) {
            alert('ERROR: ' + e.data);
        }
    };

    document.getElementById('go').onclick = function() {
        ws.send(JSON.stringify({"cmd":"user",
                                "data":document.getElementById("user").value}));
    }

    document.getElementById('stop').onclick = function() {
        var xhr2 = new XMLHttpRequest();
        xhr2.addEventListener('load', function(e) {
            alert('stopped: ' + e.target.responseText);
            document.getElementById("response").innerHTML = "";
        });
        xhr2.open('POST', '/ephpii/launcher.php');
        var fd=new FormData();
        fd.append('cmd', 'stop');
        xhr2.send(fd);
    }
}


</script>
<style type='text/css'>
body { font-family: helvetica, arial, sans-serif; }
</style>
</head>

<body onload='init()'>
<h1>Websocket</h1>
<label for="user">Which user?</label>
<select id="user">
<option>ephp001</option>
<option>ephp002</option>
<option>ephp003</option>
</select>
<br />
<label for="script">Which script?</label>
<input id="script" value="xdtest.php" />
<br />
<input type="button" id="start" value="start servers" />
<input type="button" id="connect" value="websocket connect" />
<input type="button" id="go" value="debug" />
<input type="button" id="stop" value="stop servers" />
<br />
<div id="response"></div>

</body>
</html> 
